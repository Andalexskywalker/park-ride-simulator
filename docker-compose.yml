version: "3.9"
services:
  postgres-db:
    image: postgres:16-alpine
    container_name: postgres-db
    environment:
      - POSTGRES_DB=prr_db
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d prr_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  eureka-server:
    build:
      context: .
      dockerfile: eureka-server/Dockerfile
    ports: ["8761:8761"]
    environment:
      - JAVA_TOOL_OPTIONS=-XX:+UseSerialGC -Xss256k -Xmx320m
    deploy:
      resources:
        limits:
          memory: 384M

  api-gateway:
    build:
      context: .
      dockerfile: api-gateway/Dockerfile
    ports: ["8080:8080"]
    environment:
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=api-gateway
      - JAVA_TOOL_OPTIONS=-XX:+UseSerialGC -Xss256k -Xmx320m
    deploy:
      resources:
        limits:
          memory: 384M
    depends_on:
      - eureka-server

  service-parques:
    build:
      context: .
      dockerfile: service-parques/Dockerfile
    environment:
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=service-parques
      - SERVER_PORT=8081
      - SERVICE_NAME=service-parques
      - CONTEXT_PATH=/parques
      - DB_URL=jdbc:postgresql://postgres-db:5432/prr_db
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - JAVA_TOOL_OPTIONS=-XX:+UseSerialGC -Xss256k -Xmx192m
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      eureka-server:
        condition: service_started
      postgres-db:
        condition: service_healthy

  service-utilizadores:
    build:
      context: .
      dockerfile: service-utilizadores/Dockerfile
    environment:
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=service-utilizadores
      - SERVER_PORT=8082
      - SERVICE_NAME=service-utilizadores
      - CONTEXT_PATH=/utilizadores
      - DB_URL=jdbc:postgresql://postgres-db:5432/prr_db
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - JWT_SECRET=${JWT_SECRET}
      - JAVA_TOOL_OPTIONS=-XX:+UseSerialGC -Xss256k -Xmx192m
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      eureka-server:
        condition: service_started
      postgres-db:
        condition: service_healthy

  service-sessoes:
    build:
      context: .
      dockerfile: service-sessoes/Dockerfile
    environment:
      - PARQUES_BASE=http://service-parques:8081
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=service-sessoes
      - SERVER_PORT=8083
      - SERVICE_NAME=service-sessoes
      - CONTEXT_PATH=/sessoes
      - DB_URL=jdbc:postgresql://postgres-db:5432/prr_db
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - JAVA_TOOL_OPTIONS=-XX:+UseSerialGC -Xss256k -Xmx192m
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      eureka-server:
        condition: service_started
      postgres-db:
        condition: service_healthy

  service-tarifas-faturacao:
    build:
      context: .
      dockerfile: service-tarifas-faturacao/Dockerfile
    environment:
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=service-tarifas-faturacao
      - SERVER_PORT=8084
      - SERVICE_NAME=service-tarifas-faturacao
      - CONTEXT_PATH=/tarifas
      - DB_URL=jdbc:postgresql://postgres-db:5432/prr_db
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - JAVA_TOOL_OPTIONS=-XX:+UseSerialGC -Xss256k -Xmx192m
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      eureka-server:
        condition: service_started
      postgres-db:
        condition: service_healthy

  service-reco-analytics:
    build:
      context: .
      dockerfile: service-reco-analytics/Dockerfile
    environment:
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=true
      - EUREKA_INSTANCE_HOSTNAME=service-reco-analytics
      - SERVER_PORT=8085
      - SERVICE_NAME=service-reco-analytics
      - CONTEXT_PATH=/reco
      - DB_URL=jdbc:postgresql://postgres-db:5432/prr_db
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - JAVA_TOOL_OPTIONS=-XX:+UseSerialGC -Xss256k -Xmx192m
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      eureka-server:
        condition: service_started
      postgres-db:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
    ports:
      - "3001:80"
    environment:
      - VITE_API_URL=http://localhost:8080
    depends_on:
      - api-gateway
